//
var BSON = require('mongodb').BSONPure;
var passport = require('passport');
var db = require('mylib/db');
var User = db.User;
var string = require('string');

exports.prepareUserForSession = function() {
	
	passport.serializeUser(function(user, done2) {
          done2(null, user._id);

        });

   passport.deserializeUser(function(id, done2) {
      var o_id = new BSON.ObjectID(id);
      User.findOne({_id:o_id}, function (err, user) {
        done2(err, user);
      });
    });


}

exports.render = function(path, req, res, params) {
  params["user"] = req.user;
  if (!string(req.flash('error')).isEmpty()) {
    params["error"] = req.flash('error');
  }
  if (!string(req.flash('info')).isEmpty()) {
    params["message"] = req.flash('info'); 
  }
  
  res.render(path, params);
}

exports.login = function(req, res, next) {
  if (req.isAuthenticated()) { return next(); }

  res.redirect('/login?r=' + encodeURIComponent(req.url));
}